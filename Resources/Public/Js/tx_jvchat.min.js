var tx_jvchat_pi1_js_chat_instance=null;function tx_jvchat_pi1_js_chat(){this.refreshMessagesTime=5e3,this.refreshUserlistTime=1e4,tx_jvchat_pi1_js_chat_instance="chat_instance",this.maxActiveRequests=3,this.popup=!0,this.debug=!0,this.userlistPMInfo="Send a private message to '%s'",this.userlistPRInfo="Open a new room and invite '%s'",this.allowPrivateMessages=!1,this.allowPrivateRooms=!1,this.talkToNewRoomName="New Room with %s",this.checkFullTime=2e4,this.checkFullStatusElement=$("#tx-jvchat-full-jsstatus"),this.autoFocus=!1,this.chatWindow=window;this.messageStack=new Array,this.receivedMessages=new Array,this.oldMessage="";var userList=new Array,self=null;(tx_jvchat_pi1_js_chat_instance=this).init=function(){if(initConfig=$("#tx-jvchat-config"),this.roomId=initConfig.data("roomid"),this.pid=initConfig.data("pid"),this.userId=initConfig.data("userid"),this.scriptUrl=initConfig.data("scripturl"),this.leaveUrl=initConfig.data("leaveurl"),this.newWindowUrl=initConfig.data("newwindowurl"),this.initialId=initConfig.data("initialid"),this.charset="utf-8",this.lang=initConfig.data("lang"),this.usernameGlue=initConfig.data("usernameglue"),this.usernamesFieldGlue=initConfig.data("usernamesfieldglue"),this.messagesGlue=initConfig.data("messagesglue"),this.idGlue=initConfig.data("idglue"),this.showTime=initConfig.data("showtime"),this.showEmoticons=initConfig.data("showemoticons"),this.popupJSWindowParams=initConfig.data("popupparams"),this.talkToNewRoomName=initConfig.data("talktonewroomname"),this.refreshMessagesTime=initConfig.data("refreshmessagestime"),this.refreshUserlistTime=initConfig.data("refreshuserlisttime"),this.allowPrivateMessages=initConfig.data("allowprivatemessages"),this.allowPrivateRooms=initConfig.data("allowprivaterooms"),this.privateMsgCode=initConfig.data("privatemsgcode"),this.privateRoomCode=initConfig.data("privateroomcode"),this.inputElement=$("#txjvchatnewMessage"),this.messagesElement=$("#tx-jvchat-messages"),this.userListElement=$("#tx-jvchat-userlist"),this.emoticonsElement=$("#tx-jvchat-emoticons"),this.toolsElement=$("#tx-jvchat-tools-container"),this.storedMessagesElement=$("#tx-jvchat-storedMessages"),tx_jvchat_pi1_js_chat_instance,null!=Cookie.get("tx-jvchat-emoticons_visible")){var show="1"==Cookie.get("tx-jvchat-emoticons_visible");this.setEmoticons(show)}else this.setEmoticons(this.showEmoticons);if(null!=Cookie.get("tx_jvchat_showtime")){show="1"==Cookie.get("tx_jvchat_showtime");this.setAllTime(show)}else this.setAllTime(this.showTime);self=this,chat_instance=this},this.run=function(){this.id=this.initialId,$("#txjvchatnewMessage").keypress(function(event){if(13==event.which||10==event.which){if(!event.shiftKey)return self.submitMessage();this.insertAtCursor(self.inputElement,"\r\n")}}),this.messagesElement.show(),this.toolsElement.show(),this.inputElement.focus(),this.getMessages(!1),this.getUserlist()};var handleAjaxError=function(t){alert("Error "+t.status+" -- "+t.statusText)},handleAjax404=function(t){alert('Error 404: location "'+t.statusText+'" was not found.')};this.setValueToInput=function(value,addAtIfFirst){""==this.inputElement.value&&addAtIfFirst?this.insertAtCursor(this.inputElement,"@"+value+": "):this.insertAtCursor(this.inputElement,value)},this.newWindow=function(){tx_jvchat_openNewChatWindow(this.newWindowUrl,this.roomId)},this.openChatWindow=function(chatId){tx_jvchat_openNewChatWindow(this.newWindowUrl,chatId)},this.getMessages=function(noSetTimeout){jQuery.ajax({type:"GET",url:this.scriptUrl,cache:!1,data:"r="+this.roomId+"&p="+this.pid+"&a=gm&t="+this.id+"&charset="+this.charset+"&l="+this.lang+"&showJason=0",beforeSend:function(){},success:function(result){getMessagesResponseHandler(result)},onFailure:handleAjaxError,on404:handleAjax404}),noSetTimeout||(this.runningto=window.setTimeout("tx_jvchat_pi1_js_chat_instance.getMessages()",this.refreshMessagesTime))};var getMessagesResponseHandler=function(t){self.parseMessages(t)};this.htmlspecialchars=function(str,typ){void 0===str&&(str=""),"number"!=typeof typ&&(typ=2),typ=Math.max(0,Math.min(3,parseInt(typ)));var from=new Array(/&/g,/</g,/>/g),to=new Array("&amp;","&lt;","&gt;");for(var i in 1!=typ&&3!=typ||(from.push(/'/g),to.push("&#039;")),2!=typ&&3!=typ||(from.push(/"/g),to.push("&quot;")),from)str=str.replace(from[i],to[i]);return str},this.parseString=function(string){return null==string?null:string.documentElement},this.parseMessages=function(string){if(string!=this.oldMessage){var x=this.parseString(string);if(null!=x&&(this.oldMessage=string,null!=x.attributes)){var newid=0;if(x.attributes[0]&&(newid=x.attributes[0].nodeValue),newid){if(newid==this.id)return;0<newid&&(this.id=newid)}for(i=0;i<x.childNodes.length;i++)if(x.childNodes[i]&&x.childNodes[i].firstChild&&x.childNodes[i].firstChild.data){var text=$.trim(x.childNodes[i].firstChild.data),command=text.replace(/<.*?>/g,"");switch(command=command.substr(1,4)){case"quit":window.setTimeout("tx_jvchat_pi1_js_chat_instance.quit()",1500);break;case"stop":clearTimeout(this.runningto),clearTimeout(this.runningTO2);break;case"rest":this.runningto=window.setTimeout("tx_jvchat_pi1_js_chat_instance.getMessages(false)",this.refreshMessagesTime);break;default:this.createNewMessageNode(text)}}}}},this.quit=function(){clearTimeout(this.runningto)},this.notifyNewMessage=function(){this.autoFocus&&this.popup&&this.chatWindow.focus()},this.notifyUserListChange=function(){},this.createNewMessageNode=function(message){var idsearch=message.match(/<div id="([a-z0-9]*)\"/i);if(idsearch&&idsearch[1]){var id=idsearch[1];if(this.receivedMessages.inArray(id))return;this.receivedMessages[this.receivedMessages.length]=id}if(""!=message){var mustReadDivs=!1;"</span></div></div>"==message.substr(message.length-19,19)&&(message=message.substr(0,message.length-19),mustReadDivs=!0);var messageArray=message.split("http");1==messageArray.length&&(messageArray=message.split("Http")),1==messageArray.length&&(messageArray=message.split("HTTP"));var messageParsed="",start=0,end=99999;for(ii=0;ii<messageArray.length;ii++)start=0,end=messageArray[ii].indexOf(" "),length=messageArray[ii].length,end<1&&(end=length),"://"==messageArray[ii].substr(0,3)&&(start=3),"s://"==messageArray[ii].substr(0,4)&&(start=4),0<start?(messageParsed+='<a target="_blank" class="chatlink" href="http'+messageArray[ii].substr(0,end)+'">'+messageArray[ii].substr(start,end-start)+"</a>",messageParsed+=messageArray[ii].substr(end)):messageParsed+=messageArray[ii];!0===mustReadDivs&&(message=messageParsed+"</span></div></div>");var newMessageNode=document.createElement("div"),systemsearch=(newMessageNode.innerHTML=message).match(/<div class=\"(.*?tx-jvchat-system.*?)\"/i),useridsearch=message.match(/tx-jvchat-user tx-jvchat-userid-([0-9]*?)\"\>/i);message.match(/tx-jvchat-user tx-jvchat-userid-([0-9]*?)\"\>([A-Z]*?)<\/span>/i);systemsearch&&systemsearch[1]||!useridsearch||!useridsearch[1]||useridsearch[1]==this.userId||this.notifyNewMessage();var className=document.createAttribute("class");className.nodeValue="tx-jvchat-entry",newMessageNode.setAttributeNode(className),$("#tx-jvchat-messages").append(newMessageNode),$("#tx-jvchat-messages").length&&$("#tx-jvchat-messages").scrollTop($("#tx-jvchat-messages")[0].scrollHeight-$("#tx-jvchat-messages").height()),this.showTime&&this.setAllTime(this.showTime)}},this.submitMessage=function(){var newMessage=$("#txjvchatnewMessage").val();if($("#txjvchatnewMessage").val(""),"undefined"!=$.trim(newMessage)&&""!=$.trim(newMessage))return self.sendMessageToServer($.trim(newMessage)),this.runningTO2=window.setTimeout("tx_jvchat_pi1_js_chat_instance.getMessages(true)",500),!1},this.sendMessageToServer=function(message){message&&(message=encodeURIComponent(message),jQuery.ajax({type:"post",url:this.scriptUrl,cache:!1,data:"r="+this.roomId+"&p="+this.pid+"&a=sm&t="+this.id+"&l="+this.lang+"&m="+message+"&charset="+this.charset,beforeSend:function(){},success:function(result){getMessagesResponseHandler(result)},onFailure:handleAjaxError,on404:handleAjax404})),0<this.messageStack.length&&(this.runningTO3=window.setTimeout("tx_jvchat_pi1_js_chat_instance.sendMessageToServer()",500))},this.sendMessage=function(message){this.sendMessageToServer(message)},this.commitEntry=function(uid){jQuery.ajax({type:"get",url:this.scriptUrl,cache:!1,data:"r="+this.roomId+"&p="+this.pid+"&t="+this.id+"&a=commit&uid="+uid+"&showJason=0",beforeSend:function(){},success:function(result){getMessagesResponseHandler(result)},onFailure:handleAjaxError,on404:handleAjax404}),$("#tx-jvchat-entry-"+uid).getAttributeNode("class").nodeValue="tx-jvchat-committed",this.runningTO4=window.setTimeout("tx_jvchat_pi1_js_chat_instance.hideEntry("+uid+") ",1e3)},this.hideEntry=function(uid){var node=$("tx-jvchat-entry-"+uid).parentNode;node.parentNode.removeChild(node),0==this.storedMessagesElement.childNodes.length&&this.toogleStoredMessages(!1)},this.storeEntry=function(uid){this.toogleStoredMessages(!0);var node=$("tx-jvchat-entry-"+uid).parentNode;this.storedMessagesElement.style.display="block",this.storedMessagesElement.append(node),node.childNodes[1].remove($("tx-jvchat-storelink-"+uid)),this.storedMessagesElement.scrollTop=this.storedMessagesElement.scrollHeight},this.toogleStoredMessages=function(show){var storedMessages=this.storedMessagesElement,messages=this.messagesElement;if("block"==storedMessages.style.display!=show){var heightStyle=messages.style.height;result=heightStyle.match(/([0-9]*?)([a-z]{2}|\%)/i);var height=result[1],hunit=result[2];if(show){newHeight=Math.round(height/2);storedMessages.style.height=newHeight-1+hunit,storedMessages.style.display="block",messages.style.height=newHeight+hunit,messages.style.top=newHeight+hunit}else{var newHeight=Math.round(2*height);storedMessages.style.display="none",messages.style.height=newHeight+hunit,messages.style.top=0}}},this.getUserlist=function(){jQuery.ajax({type:"get",url:this.scriptUrl,cache:!0,data:"r="+this.roomId+"&p="+this.pid+"&a=gu&charset="+this.charset+"&showJason=0",beforeSend:function(){},success:function(result){getUserlistResponseHandler(result)},onFailure:handleAjaxError,on404:handleAjax404}),this.runningTOul=window.setTimeout("tx_jvchat_pi1_js_chat_instance.getUserlist()",this.refreshUserlistTime)};var getUserlistResponseHandler=function(t){self.parseUserlist(t)};this.lastULResponse="",this.parseUserlist=function(string){if(string!=this.lastULResponse){this.lastULResponse=string;var x=this.parseString(string);if(null!=x){for($("#tx-jvchat-userlist").html(""),i=0;i<x.childNodes.length;i++)x.childNodes[i]&&x.childNodes[i].firstChild&&x.childNodes[i].firstChild.data&&this.createNewUserNode($.trim(x.childNodes[i].firstChild.data));this.notifyUserListChange()}}},this.clearUserList=function(){$("#tx-jvchat-userlist").html("")},this.createNewUserNode=function(value){if(""!=value){var parts=value.split(this.usernameGlue),userObj=parts[0],type=parts[1],id=parts[2],username=parts[3];userList["userid-"+id]=value,jQuery("<div/>",{class:"tx-jvchat-userlist-item tx-jvchat-userlist-"+type,html:userObj,id:"userid-"+id}).appendTo("#tx-jvchat-userlist"),parseInt(this.userId)==parseInt(id)?$("#userid-"+id+" .tx-jvchat-userlist-buttons").hide():($("#userid-"+id+" .tx-jvchat-userlist-username").bind("click",function(evt){self.setValueToInput(username,!0)}),this.allowPrivateMessages&&$("#userid-"+id+" .tx-jvchat-pm-link").bind("click",function(evt){var command="/msg #"+id+" ";self.insertCommand(command)}),this.allowPrivateRooms&&$("#userid-"+id+" .tx-jvchat-pr-link").bind("click",function(evt){var name=self.talkToNewRoomName.replace(/\%s/,username),command="/talkTo #"+id+" "+name;self.insertCommand(command)}))}},this.insertCommand=function(command){$("#txjvchatnewMessage").val(command+$("#txjvchatnewMessage").val()),$("#txjvchatnewMessage").focus()},this.toggleEmoticons=function(){"1"==Cookie.get("tx-jvchat-emoticons_visible")?this.setEmoticons("0"):this.setEmoticons("1")},this.setEmoticons=function(on){"1"==on?(Cookie.set("tx-jvchat-emoticons_visible","1",100),this.emoticonsElement.show()):(Cookie.set("tx-jvchat-emoticons_visible","0",100),this.emoticonsElement.hide())},this.toggleAllTime=function(){this.setAllTime(!this.showTime)},this.setAllTime=function(on){(this.showTime=on)?($(".tx-jvchat-time").show(),Cookie.set("tx_jvchat_showtime","1",100)):($(".tx-jvchat-time").hide(),Cookie.set("tx_jvchat_showtime","0",100))},this.doCheckFull=function(){jQuery.ajax({type:"get",url:this.scriptUrl,cache:!1,data:"r="+this.roomId+"&p="+this.pid+"&a=checkfull&showJason=0",beforeSend:function(){},success:function(result){checkFullResponse(result)},onFailure:handleAjaxError,on404:handleAjax404})},this.checkFull=function(newTry){this.checkFullTimeLeft<=0?(this.checkFullStatusElement&&this.checkFullStatusElement.html("Checking..."),this.doCheckFull()):(this.checkFullTimeLeft||(this.checkFullTimeLeft=this.checkFullTime),this.checkFullTimeLeft=this.checkFullTimeLeft-1e3,this.checkFullStatusElement&&this.checkFullStatusElement.html(Math.round(this.checkFullTimeLeft/1e3)+" s"),this.runningTO4=window.setTimeout("tx_jvchat_pi1_js_chat_instance.checkFull(false)",1e3))};var checkFullResponse=function(t){"notfull"==$.trim(t.responseText)?(self.checkFullStatusElement&&self.checkFullStatusElement.html("Free - reloading..."),window.location.reload()):(self.checkFullStatusElement&&self.checkFullStatusElement.html("Still full"),self.checkFullTimeLeft=tx_jvchat_pi1_js_chat_instance.checkFullTime,this.runningTO5=window.setTimeout("tx_jvchat_pi1_js_chat_instance.checkFull(true)",1e3))};this.start=function(){this.setStart(!this.reload)},this.setStart=function(on){this.reload=on,Cookie.set("tx_jvchat_reload",this.reload?"1":"0",100),this.reload?(this.runningto&&clearTimeout(this.runningto),this.runningto&&clearTimeout(this.runningTO2)):this.runningto=window.setTimeout("tx_jvchat_pi1_js_chat_instance.getMessages()",this.refreshMessagesTime)},this.uploadImg=function(){0<jQuery("#tx-jvchat-button-imageFormWrap").length?(jQuery("#tx-jvchat-button-imageFormWrap").remove(),tx_jvchat_resize()):jQuery.ajax({type:"GET",url:"/admin/community/gallery.html",cache:!0,data:"tx_community[action]=list&tx_community[controller]=Album&tx_community[showJason]=1",beforeSend:function(){jQuery("#tx-jvchat-button-imageForm").parent()&&jQuery("#tx-jvchat-button-imageForm").parent().remove(),jQuery("#tx-jvchat-button-image").after('<img id="tx-jvchat-button-imageLoad" src="/fileadmin/templates_2015/img/loading.gif" alt="loading..." style=\'height:27px; width:27px;\'></div>'),jQuery("#tx-jvchat-button-image").addClass("hide"),jQuery("DIV.tx-community-pi1").remove(),tx_jvchat_resize()},success:function(result){if(jQuery("#tx-jvchat-button-image").removeClass("hide"),"object"==typeof result)if(0==result.count)jQuery("#tx-jvchat-button-imageLoad").removeClass("hide");else if(1==result.count){var album=result.album[1];jQuery("#tx-jvchat-button-imageLoad").addClass("hide"),chat_instance.uploadImgGetalbum(album.id)}else{var Dropdown="",showSelect=!1;jQuery.each(result.album,function(idx,obj){Dropdown+="<option value='"+obj.id+"'>"+obj.name+" ("+obj.count+")</option>",showSelect=!0}),!0===showSelect&&jQuery("#tx-jvchat-button-image").after('<div id="tx-jvchat-button-imageFormWrap" ><select id="tx-jvchat-button-imageForm" onchange="chat_instance.uploadImgGetalbum(this.value);">\n<option>'+result.selectText+"</option>\n"+Dropdown+"</select></div>\n"),jQuery("#tx-jvchat-button-imageLoad").addClass("hide")}else jQuery("#tx-jvchat-button-imageLoad").addClass("hide");tx_jvchat_resize()}})},this.uploadImgGetalbum=function(album){jQuery.ajax({type:"GET",url:"/admin/community/gallery.html",cache:!1,data:"tx_community[action]=show&tx_community[controller]=Album&tx_community[album]="+album+"&tx_community[showHtml]=1",beforeSend:function(){jQuery("#tx-jvchat-button-imageLoad").removeClass("hide"),jQuery("#tx-jvchat-button-image").addClass("hide"),tx_jvchat_resize()},success:function(result){this.resizeChatWindow,jQuery("#tx-jvchat-button-imageForm").parent().remove(),jQuery("#tx-jvchat-button-image").removeClass("hide").after(result),jQuery("#tx-jvchat-button-imageLoad").remove(),tx_jvchat_resize()}})},this.addImage=function(bigImg,smallImg){smallImg=smallImg.replace(location.protocol+"//"+location.hostname,""),bigImg=bigImg.replace(location.protocol+"//"+location.hostname,""),this.addSelText("[img=/"+bigImg+"]"+smallImg+"[/img]","")},this.showChatImg=function(bigImg){jQuery.ajax({type:"GET",url:bigImg,cache:!0,data:"",beforeSend:function(){jQuery("#wrap").before('<div id="tx-jvchat-bigimageLayer" onclick="chat_instance.hideChatImg();" style="position:absolute; display:block;height:100%; width:100%; background: rgba(183,183,183,0.7); z-index: 900;"></div>'),jQuery("#tx-jvchat-bigimageLayer").css("position","absolute")},success:function(result){jQuery("#tx-jvchat-bigimageLayer").html('<div id="tx-jvchat-bigimageWrap"><img  id="tx-jvchat-bigimage" alt="click me" onclick="chat_instance.hideChatImg();" title="click me" src="'+bigImg+'" /></div>'),jQuery("#tx-jvchat-bigimageWrap").css("z-index","999"),jQuery("#tx-jvchat-bigimageWrap").css("position","absolute"),jQuery("#tx-jvchat-bigimage").css("display","block");var marginTop=parseInt((jQuery(window).height()-parseInt(jQuery("#tx-jvchat-bigimageWrap").css("height")))/2),marginLeft=parseInt((jQuery(window).width()-parseInt(jQuery("#tx-jvchat-bigimageWrap").css("width")))/2);marginTop<0&&(marginTop=0),marginLeft<0&&(marginLeft=0)}})},this.hideChatImg=function(){jQuery("#tx-jvchat-bigimageLayer").remove()},this.addSelText=function(aTag,eTag){var CPos=$("#txjvchatnewMessage").caret(),t=$("#txjvchatnewMessage").range().text;CPos+=aTag.length,$("#txjvchatnewMessage").range(aTag+t+eTag),$("#txjvchatnewMessage").focus(),$("#txjvchatnewMessage").caret(parseInt(CPos))},this.insertAtCursor=function(myField,myValue){$("#txjvchatnewMessage").caret();$("#txjvchatnewMessage").caret(myValue),$("#txjvchatnewMessage").focus()}}var Cookie={set:function(name,value,daysToExpire){var expire="";if(null!=daysToExpire){var d=new Date;d.setTime(d.getTime()+864e5*parseFloat(daysToExpire)),expire="; expires="+d.toGMTString()}return document.cookie=encodeURI(name)+"="+encodeURI(value||"")+expire},get:function(name){var cookie=document.cookie.match(new RegExp("(^|;)\\s*"+encodeURI(name)+"=([^;\\s]*)"));return cookie?decodeURI(cookie[2]):null},erase:function(name){var cookie=Cookie.get(name)||!0;return Cookie.set(name,"",-1),cookie},accept:function(){return"boolean"==typeof navigator.cookieEnabled?navigator.cookieEnabled:(Cookie.set("_test","1"),"1"===Cookie.erase("_test"))}};function openChatWindow(id){chat_instance.openChatWindow(id)}function setValueToInput(value){chat_instance.setValueToInput(value)}function tx_jvchat_resize(){var totalH=$(window).height(),otherH=60;$(window).width()<767?otherH=$("#tx-jvchat-userlist").height()+60:$("#tx-jvchat-userlist").addClass("in").attr("aria-expanded","true").css("height","auto"),totalH<400?$("#txjvchatnewMessage").css("height","46px"):$("#txjvchatnewMessage").css("height","92px");var infoH=$(".tx-jvchat-chat-intro").height(),toolsH=$("#tx-jvchat-tools-container").height(),usersH=$("#tx-jvchat-showUserlist").height(),messH=totalH-infoH-toolsH-$("#tx-jvchat-input-container").height()-otherH-usersH;$("#tx-jvchat-messages").css("height",messH+"px")}Array.prototype.inArray=function(value){var i;for(i=0;i<this.length;i++)if(this[i]===value)return!0;return!1};