var tx_jvchat_pi1_js_chat_instance=null;function tx_jvchat_pi1_js_chat(){this.refreshMessagesTime=5e3,this.refreshUserlistTime=1e4,tx_jvchat_pi1_js_chat_instance="chat_instance",this.maxActiveRequests=3,this.popup=!0,this.debug=!0,this.userlistPMInfo="Send a private message to '%s'",this.userlistPRInfo="Open a new room and invite '%s'",this.allowPrivateMessages=!1,this.allowPrivateRooms=!1,this.talkToNewRoomName="New Room with %s",this.checkFullTime=2e4,this.checkFullStatusElement=$("#tx-jvchat-full-jsstatus"),this.autoFocus=!1,this.chatWindow=window;this.messageStack=new Array,this.receivedMessages=new Array,this.oldMessage="";var o=new Array,h=null;(tx_jvchat_pi1_js_chat_instance=this).init=function(){var t;initConfig=$("#tx-jvchat-config"),this.roomId=initConfig.data("roomid"),this.pid=initConfig.data("pid"),this.userId=initConfig.data("userid"),this.usernameSelf=initConfig.data("username"),this.scriptUrl=initConfig.data("scripturl"),this.leaveUrl=initConfig.data("leaveurl"),this.newWindowUrl=initConfig.data("newwindowurl"),this.initialId=initConfig.data("initialid"),this.charset="utf-8",this.lang=initConfig.data("lang"),this.usernameGlue=initConfig.data("usernameglue"),this.usernamesFieldGlue=initConfig.data("usernamesfieldglue"),this.messagesGlue=initConfig.data("messagesglue"),this.idGlue=initConfig.data("idglue"),this.showTime=initConfig.data("showtime"),this.showEmoticons=initConfig.data("showemoticons"),this.popupJSWindowParams=initConfig.data("popupparams"),this.talkToNewRoomName=initConfig.data("talktonewroomname"),this.refreshMessagesTime=initConfig.data("refreshmessagestime"),this.refreshUserlistTime=initConfig.data("refreshuserlisttime"),this.allowPrivateMessages=initConfig.data("allowprivatemessages"),this.allowPrivateRooms=initConfig.data("allowprivaterooms"),this.privateMsgCode=initConfig.data("privatemsgcode"),this.privateRoomCode=initConfig.data("privateroomcode"),this.inputElement=$("#txjvchatnewMessage"),this.messagesElement=$("#tx-jvchat-messages"),this.userListElement=$("#tx-jvchat-userlist"),this.emoticonsElement=$("#tx-jvchat-emoticons"),this.toolsElement=$("#tx-jvchat-tools-container"),this.storedMessagesElement=$("#tx-jvchat-storedMessages"),this.reload=Cookie.get("tx_jvchat_reload"),null!=Cookie.get("tx-jvchat-emoticons_visible")?(t="1"==Cookie.get("tx-jvchat-emoticons_visible"),this.setEmoticons(t)):this.setEmoticons(0),this.showTime&&(null!=Cookie.get("tx_jvchat_showtime")?(t="1"==Cookie.get("tx_jvchat_showtime"),this.setAllTime(t)):this.setAllTime(this.showTime)),chat_instance=h=this},this.run=function(){this.id=this.initialId,$("#txjvchatnewMessage").keypress(function(t){if(13==t.which||10==t.which){if(!t.shiftKey)return h.submitMessage();h.insertAtCursor(h.inputElement,"\r\n")}}),this.messagesElement.show(),this.toolsElement.show(),this.inputElement.focus(),this.getMessages(!1),this.getUserlist(),this.handleImageUpload(),this.setStart(this.reload)},this.handleImageUpload=function(){jQuery("#chat-uploaded-file")&&jQuery("#chat-uploaded-file").fileupload({url:jQuery("#tx-jvchat-config").data("scripturl")+"&a=pi&r="+this.roomId,dataType:"json",start:function(){showSpinner(),jQuery("#tx-jvchat-upload-container").removeClass("in"),jQuery("#tx-jvchat-button-imageDirect").attr("area-expanded",!1)},always:function(t){setTimeout(hideSpinner,3e3)}})};function s(t){alert("Error "+t.status+" -- "+t.statusText)}function a(t){alert('Error 404: location "'+t.statusText+'" was not found.')}this.setValueToInput=function(t,e){""==this.inputElement.value&&e?this.insertAtCursor(this.inputElement,"@"+t+": "):this.insertAtCursor(this.inputElement,t)},this.newWindow=function(){tx_jvchat_openNewChatWindow(this.newWindowUrl,this.roomId)},this.openChatWindow=function(t){tx_jvchat_openNewChatWindow(this.newWindowUrl,t)},this.getMessages=function(t){jQuery.ajax({type:"GET",url:this.scriptUrl,cache:!1,data:"r="+this.roomId+"&p="+this.pid+"&a=gm&t="+this.id+"&charset="+this.charset+"&l="+this.lang+"&u="+this.userId+"&showJason=0",beforeSend:function(){},success:function(t){n(t)},onFailure:s,on404:a}),t||(this.runningto=window.setTimeout("tx_jvchat_pi1_js_chat_instance.getMessages()",this.refreshMessagesTime))};var n=function(t){h.parseMessages(t)};this.htmlspecialchars=function(t,e){void 0===t&&(t=""),"number"!=typeof e&&(e=2),e=Math.max(0,Math.min(3,parseInt(e)));var i=new Array(/&/g,/</g,/>/g),s=new Array("&amp;","&lt;","&gt;");for(var a in 1!=e&&3!=e||(i.push(/'/g),s.push("&#039;")),2!=e&&3!=e||(i.push(/"/g),s.push("&quot;")),i)t=t.replace(i[a],s[a]);return t},this.parseString=function(t){return null==t?null:t.documentElement},this.parseMessages=function(t){if(t!=this.oldMessage){var e=this.parseString(t);if(null!=e&&(this.oldMessage=t,null!=e.attributes)){var s=0;if(e.attributes[0]&&(s=e.attributes[0].nodeValue),s){if(s==this.id)return;0<s&&(this.id=s)}for(i=0;i<e.childNodes.length;i++)if(e.childNodes[i]&&e.childNodes[i].firstChild&&e.childNodes[i].firstChild.data){var a=$.trim(e.childNodes[i].firstChild.data);switch(a.replace(/<.*?>/g,"").substr(1,4)){case"quit":window.setTimeout("tx_jvchat_pi1_js_chat_instance.quit()",1500);break;case"stop":this.runningto&&clearTimeout(this.runningto),this.runningTO2&&clearTimeout(this.runningTO2);break;case"rest":this.runningto=window.setTimeout("tx_jvchat_pi1_js_chat_instance.getMessages(false)",this.refreshMessagesTime);break;default:this.createNewMessageNode(a)}}}}},this.quit=function(){this.runningto&&clearTimeout(this.runningto)},this.notifyNewMessage=function(){this.autoFocus&&this.popup&&this.chatWindow.focus()},this.notifyUserListChange=function(){},this.createNewMessageNode=function(t){var e=t.match(/<div id="([a-z0-9]*)\"/i);if(e&&e[1]){var i=e[1];if(this.receivedMessages.inArray(i))return;this.receivedMessages[this.receivedMessages.length]=i}if(""!=t){var s=!1;"</span></div></div>"==t.substr(t.length-19,19)&&(t=t.substr(0,t.length-19),s=!0);var a=t.split("http");1==a.length&&(a=t.split("Http")),1==a.length&&(a=t.split("HTTP"));var n="",o=0,h=99999;for(ii=0;ii<a.length;ii++)o=0,h=a[ii].indexOf(" "),length=a[ii].length,h<1&&(h=length),"://"==a[ii].substr(0,3)&&(o=3),"s://"!=a[ii].substr(0,4)&&"S://"!=a[ii].substr(0,4)||(o=4),0<o?(n+='<a target="_blank" class="chatlink" href="http'+a[ii].substr(0,h)+'">'+a[ii].substr(o,h-o)+"</a>",n+=a[ii].substr(h)):n+=a[ii];!0===s&&(t=n+"</span></div></div>");var r=document.createElement("div"),c=(r.innerHTML=t).match(/<div class=\"(.*?tx-jvchat-system.*?)\"/i),l=t.match(/tx-jvchat-user tx-jvchat-userid-([0-9]*?)\"\>/i);t.match(/tx-jvchat-user tx-jvchat-userid-([0-9]*?)\"\>([A-Z]*?)<\/span>/i);c&&c[1]||!l||!l[1]||l[1]==this.userId||this.notifyNewMessage();var u=document.createAttribute("class");u.nodeValue="tx-jvchat-entry",r.setAttributeNode(u),$("#tx-jvchat-messages").append(r),$("#tx-jvchat-messages").length&&$("#tx-jvchat-messages").scrollTop($("#tx-jvchat-messages")[0].scrollHeight-$("#tx-jvchat-messages").height()),this.showTime&&this.setAllTime(this.showTime)}},this.submitMessage=function(){var t=$("#txjvchatnewMessage").val();if($("#txjvchatnewMessage").val(""),"undefined"!=$.trim(t)&&""!=$.trim(t))return h.sendMessageToServer($.trim(t)),this.reload||this.setStart(1),this.getMessages(!0),!1},this.sendMessageToServer=function(t){t&&(t=encodeURIComponent(t),jQuery.ajax({type:"post",url:this.scriptUrl,cache:!1,data:"r="+this.roomId+"&p="+this.pid+"&a=sm&t="+this.id+"&l="+this.lang+"&m="+t+"&charset="+this.charset,beforeSend:function(){},success:function(t){n(t)},onFailure:s,on404:a})),0<this.messageStack.length&&(this.runningTO3=window.setTimeout("tx_jvchat_pi1_js_chat_instance.sendMessageToServer()",500))},this.sendMessage=function(t){this.sendMessageToServer(t)},this.commitEntry=function(t){jQuery.ajax({type:"get",url:this.scriptUrl,cache:!1,data:"r="+this.roomId+"&p="+this.pid+"&t="+this.id+"&a=commit&uid="+t+"&showJason=0",beforeSend:function(){},success:function(t){n(t)},onFailure:s,on404:a}),$("#tx-jvchat-entry-"+t).getAttributeNode("class").nodeValue="tx-jvchat-committed",this.runningTO4=window.setTimeout("tx_jvchat_pi1_js_chat_instance.hideEntry("+t+") ",1e3)},this.hideEntry=function(t,e){confirm("Delete really | Wirklich lÃ¶schen?")&&(jQuery.ajax({type:"get",url:this.scriptUrl,cache:!1,data:"a=del&uid="+e+"&showJason=0",beforeSend:function(){},success:function(t){n(t)},onFailure:s,on404:a}),$(t).length&&$(t).parent().remove(),this.storedMessagesElement.length&&this.storedMessagesElement.childNodes&&0==this.storedMessagesElement.childNodes.length&&this.toogleStoredMessages(!1))},this.storeEntry=function(t){this.toogleStoredMessages(!0);var e=$("tx-jvchat-entry-"+t).parentNode;this.storedMessagesElement.style.display="block",this.storedMessagesElement.append(e),e.childNodes[1].remove($("tx-jvchat-storelink-"+t)),this.storedMessagesElement.scrollTop=this.storedMessagesElement.scrollHeight},this.toogleStoredMessages=function(t){var e,i,s,a,n=this.storedMessagesElement,o=this.messagesElement;"block"==n.style.display!=t&&(e=o.style.height,result=e.match(/([0-9]*?)([a-z]{2}|\%)/i),i=result[1],s=result[2],t?(a=Math.round(i/2),n.style.height=a-1+s,n.style.display="block",o.style.height=a+s,o.style.top=a+s):(a=Math.round(2*i),n.style.display="none",o.style.height=a+s,o.style.top=0))},this.getUserlist=function(){jQuery.ajax({type:"get",url:this.scriptUrl,cache:!0,data:"r="+this.roomId+"&p="+this.pid+"&a=gu&charset="+this.charset+"&showJason=0",beforeSend:function(){},success:function(t){e(t)},onFailure:s,on404:a}),this.runningTOul=window.setTimeout("tx_jvchat_pi1_js_chat_instance.getUserlist()",this.refreshUserlistTime)};var e=function(t){h.parseUserlist(t)};this.lastULResponse="",this.parseUserlist=function(t){if(t!=this.lastULResponse){this.lastULResponse=t;var e=this.parseString(t);if(null!=e){$("#tx-jvchat-userlist").html("");var s=0;for(i=0;i<e.childNodes.length;i++)e.childNodes[i]&&e.childNodes[i].firstChild&&e.childNodes[i].firstChild.data&&(this.createNewUserNode($.trim(e.childNodes[i].firstChild.data)),s++);$("#tx-jvchat-usercount")&&$("#tx-jvchat-usercount").html(s),this.notifyUserListChange()}}},this.clearUserList=function(){$("#tx-jvchat-userlist").html("")},this.createNewUserNode=function(t){var e,i,s,a,n;""!=t&&(i=(e=t.split(this.usernameGlue))[0],s=e[1],a=e[2],n=e[3],o["userid-"+a]=t,jQuery("<div/>",{class:"tx-jvchat-userlist-item tx-jvchat-userlist-"+s,html:i,id:"userid-"+a}).appendTo("#tx-jvchat-userlist"),parseInt(this.userId)==parseInt(a)?$("#userid-"+a+" .tx-jvchat-userlist-buttons").hide():($("#userid-"+a+" .tx-jvchat-userlist-username").bind("click",function(t){h.setValueToInput(n,!0)}),this.allowPrivateMessages&&$("#userid-"+a+" .tx-jvchat-pm-link").bind("click",function(t){var e="/msg #"+a+" ";h.insertCommand(e)}),this.allowPrivateRooms&&$("#userid-"+a+" .tx-jvchat-pr-link").bind("click",function(t){var e=h.talkToNewRoomName.replace(/\%s/,n),i="/talkTo #"+a+" "+e;h.sendMessage(i)})))},this.insertCommand=function(t){$("#txjvchatnewMessage").val(t+$("#txjvchatnewMessage").val()),$("#txjvchatnewMessage").focus()},this.toggleEmoticons=function(){"1"==Cookie.get("tx-jvchat-emoticons_visible")?this.setEmoticons("0"):this.setEmoticons("1")},this.setEmoticons=function(t){"1"==t?(Cookie.set("tx-jvchat-emoticons_visible","1",100),this.emoticonsElement.show()):(Cookie.set("tx-jvchat-emoticons_visible","0",100),this.emoticonsElement.hide())},this.toggleAllTime=function(){this.setAllTime(!this.showTime)},this.setAllTime=function(t){(this.showTime=t)?($(".tx-jvchat-time").show(),Cookie.set("tx_jvchat_showtime","1",100)):($(".tx-jvchat-time").hide(),Cookie.set("tx_jvchat_showtime","0",100))},this.doCheckFull=function(){jQuery.ajax({type:"get",url:this.scriptUrl,cache:!1,data:"r="+this.roomId+"&p="+this.pid+"&a=checkfull&showJason=0",beforeSend:function(){},success:function(t){r(t)},onFailure:s,on404:a})},this.checkFull=function(t){this.checkFullTimeLeft<=0?(this.checkFullStatusElement&&this.checkFullStatusElement.html("Checking..."),this.doCheckFull()):(this.checkFullTimeLeft||(this.checkFullTimeLeft=this.checkFullTime),this.checkFullTimeLeft=this.checkFullTimeLeft-1e3,this.checkFullStatusElement&&this.checkFullStatusElement.html(Math.round(this.checkFullTimeLeft/1e3)+" s"),this.runningTO4=window.setTimeout("tx_jvchat_pi1_js_chat_instance.checkFull(false)",1e3))};var r=function(t){"notfull"==$.trim(t.responseText)?(h.checkFullStatusElement&&h.checkFullStatusElement.html("Free - reloading..."),window.location.reload()):(h.checkFullStatusElement&&h.checkFullStatusElement.html("Still full"),h.checkFullTimeLeft=tx_jvchat_pi1_js_chat_instance.checkFullTime,this.runningTO5=window.setTimeout("tx_jvchat_pi1_js_chat_instance.checkFull(true)",1e3))};this.start=function(){this.setStart(!this.reload)},this.setStart=function(t){this.reload=t,Cookie.set("tx_jvchat_reload",this.reload?"1":"0",100),this.reload?(this.runningto||(this.runningto=window.setTimeout("tx_jvchat_pi1_js_chat_instance.getMessages()",this.refreshMessagesTime)),jQuery("#tx-jvchat-button-start-on").parent().addClass("hide").addClass("d-none"),jQuery("#tx-jvchat-button-start").parent().removeClass("hide").removeClass("d-none")):(jQuery("#tx-jvchat-button-start").parent().addClass("hide").addClass("d-none"),jQuery("#tx-jvchat-button-start-on").parent().removeClass("hide").removeClass("d-none"),this.runningto&&(clearTimeout(this.runningto),this.runningto=!1),this.runningTO2&&clearTimeout(this.runningTO2))},this.uploadImg=function(){0<jQuery("#tx-jvchat-button-imageFormWrap").length?(jQuery("#tx-jvchat-button-imageFormWrap").remove(),jQuery("#tx-jvchat-button-image").parent().removeClass("tx-jvchat-button-image-action"),tx_jvchat_resize()):jQuery.ajax({type:"GET",url:"/admin/community/gallery.html",cache:!0,data:"tx_community[action]=list&tx_community[controller]=Album&tx_community[showJason]=1",beforeSend:function(){jQuery("#tx-jvchat-button-imageForm").parent()&&jQuery("#tx-jvchat-button-imageForm").parent().remove(),jQuery("#tx-jvchat-button-image").after("<span  id='tx-jvchat-button-imageLoad' class='fa fa-spinner fa-spin' />"),jQuery("#tx-jvchat-button-image").addClass("hide"),jQuery("DIV.tx-community-pi1").remove(),tx_jvchat_resize()},success:function(t){var e,i,s;jQuery("#tx-jvchat-button-image").removeClass("hide"),jQuery("#tx-jvchat-button-image").parent().addClass("tx-jvchat-button-image-action"),"object"==typeof t?0==t.count?(jQuery("#tx-jvchat-button-imageLoad").addClass("hide"),jQuery("#tx-jvchat-button-image").parent().remove()):1==t.count?(e=t.album[1],jQuery("#tx-jvchat-button-imageLoad").addClass("hide"),chat_instance.uploadImgGetalbum(e.id)):(i="",s=!1,jQuery.each(t.album,function(t,e){i+="<option value='"+e.id+"'>"+e.name+" ("+e.count+")</option>",s=!0}),!0===s&&jQuery("#tx-jvchat-button-image").after('<div id="tx-jvchat-button-imageFormWrap" ><select id="tx-jvchat-button-imageForm" onchange="chat_instance.uploadImgGetalbum(this.value);">\n<option>'+t.selectText+"</option>\n"+i+"</select></div>\n"),jQuery("#tx-jvchat-button-imageLoad").addClass("hide")):jQuery("#tx-jvchat-button-imageLoad").addClass("hide"),tx_jvchat_resize()}})},this.uploadImgGetalbum=function(t){jQuery.ajax({type:"GET",url:"/admin/community/gallery.html",cache:!1,data:"tx_community[action]=show&tx_community[controller]=Album&tx_community[album]="+t+"&tx_community[showHtml]=1",beforeSend:function(){jQuery("#tx-jvchat-button-imageLoad").removeClass("hide"),jQuery("#tx-jvchat-button-image").addClass("hide"),tx_jvchat_resize()},success:function(t){this.resizeChatWindow,jQuery("#tx-jvchat-button-imageForm").parent().remove(),jQuery("#tx-jvchat-button-image").removeClass("hide").after(t),jQuery("#tx-jvchat-button-imageLoad").remove(),tx_jvchat_resize()}})},this.addImage=function(t,e){e=e.replace(location.protocol+"//"+location.hostname,""),t=t.replace(location.protocol+"//"+location.hostname,""),this.addSelText("[img=/"+t+"]"+e+"[/img]","")},this.showChatImg=function(e){jQuery.ajax({type:"GET",url:e,cache:!0,data:"",beforeSend:function(){jQuery("#mainContent").before('<div id="tx-jvchat-bigimageLayer" onclick="chat_instance.hideChatImg();" style="position:absolute; display:block;height:100%; width:100%; background: rgba(183,183,183,0.7); z-index: 900;overflow: auto"></div>'),jQuery("#tx-jvchat-bigimageLayer").css("position","absolute")},success:function(t){jQuery("#tx-jvchat-bigimageLayer").html('<div id="tx-jvchat-bigimageWrap"><img  id="tx-jvchat-bigimage" alt="click me" onclick="chat_instance.hideChatImg();" title="click me" src="'+e+'" /></div>'),jQuery("#tx-jvchat-bigimageWrap").css("z-index","999"),jQuery("#tx-jvchat-bigimageWrap").css("position","absolute"),jQuery("#tx-jvchat-bigimage").css("display","block"),parseInt((jQuery(window).height()-parseInt(jQuery("#tx-jvchat-bigimageWrap").css("height")))/2),parseInt((jQuery(window).width()-parseInt(jQuery("#tx-jvchat-bigimageWrap").css("width")))/2)}})},this.hideChatImg=function(){jQuery("#tx-jvchat-bigimageLayer").remove()},this.addSelText=function(t,e){var i=$("#txjvchatnewMessage").caret(),s=$("#txjvchatnewMessage").range().text;i+=t.length,$("#txjvchatnewMessage").range(t+s+e),$("#txjvchatnewMessage").focus(),$("#txjvchatnewMessage").caret(parseInt(i))},this.insertAtCursor=function(t,e){$("#txjvchatnewMessage").caret();$("#txjvchatnewMessage").caret(e),$("#txjvchatnewMessage").focus()}}var Cookie={set:function(t,e,i){var s,a="";return null!=i&&((s=new Date).setTime(s.getTime()+864e5*parseFloat(i)),a="; expires="+s.toGMTString()),document.cookie=encodeURI(t)+"="+encodeURI(e||"")+a},get:function(t){var e=document.cookie.match(new RegExp("(^|;)\\s*"+encodeURI(t)+"=([^;\\s]*)"));return e?decodeURI(e[2]):null},erase:function(t){var e=Cookie.get(t)||!0;return Cookie.set(t,"",-1),e},accept:function(){return"boolean"==typeof navigator.cookieEnabled?navigator.cookieEnabled:(Cookie.set("_test","1"),"1"===Cookie.erase("_test"))}};function openChatWindow(t){chat_instance.openChatWindow(t)}function setValueToInput(t){chat_instance.setValueToInput(t)}function tx_jvchat_resize(){var t=parseInt($(window).height()),e=parseInt($("#tx-jvchat-input-container").height());t<700?($("#txjvchatnewMessage").css("height","46px"),isNaN(e)&&(e=46)):($("#txjvchatnewMessage").css("height","96px"),isNaN(e)&&(e=96));var i=parseInt($("#mainnavIcons").height());isNaN(i)?i=0:i+=10;var s=parseInt($("#jvEventsAjaxMenu").height());isNaN(s)&&(s=0);var a=parseInt($(".fixed-bottom").height());isNaN(a)?a=0:a+=8;var n=parseInt($(".tx-jvchat-chat-intro").height());isNaN(n)&&(n=0);var o=parseInt($("#tx-jvchat-tools-container").height());isNaN(o)&&(o=0);var h=parseInt($("#tx-jvchat-userlist").height());isNaN(h)&&(h=0);var r=parseInt(t-i-s-a-60-n-o-e-h-20);(r<300||isNaN(r))&&(r=300),$("#tx-jvchat-messages").css("height",r+"px")}Array.prototype.inArray=function(t){for(var e=0;e<this.length;e++)if(this[e]===t)return!0;return!1};